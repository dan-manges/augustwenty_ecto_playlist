on:
  github:
    pull_request:
      init:
        commit-sha: ${{ event.git.sha }}
  cli:
    init:
      commit-sha: ${{ event.git.sha }}

base:
  image: ubuntu:24.04
  config: rwx/base 1.0.0

tasks:
  - key: packages
    run: |
      sudo apt-get update
      sudo apt-get install -y postgresql-client
      sudo apt-get clean

  - key: code
    call: git/clone 2.0.3
    with:
      repository: https://github.com/augustwenty/ecto_playlist.git
      ref: ${{ init.commit-sha }}

  - key: erlang
    call: erlang/install 1.1.1
    with:
      erlang-version: "26.2.2"

  - key: elixir
    use: erlang
    call: elixir-lang/install 1.1.2
    with:
      elixir-version: "1.17.2"

  - key: deps
    use: [code, packages, erlang, elixir]
    run: mix do deps.get, deps.compile
    filter:
      - mix.lock
      - mix.exs
    env:
      MIX_ENV: test

  - key: compile
    use: [packages, deps]
    run: mix compile
    env:
      MIX_ENV: test

  - key: test
    use: compile
    docker: true
    run: |
      mix test
